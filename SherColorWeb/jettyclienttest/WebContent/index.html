<!DOCTYPE html>
<link rel="stylesheet" type="text/css"
	href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" />
<script type="text/javascript"
	src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script type="text/javascript"
	src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript" src="scripts/spectro.js"></script>
<script type="text/javascript" src="scripts/tinter.js"></script>


<head>
<script>
  // helper function: log message to screen
  function log(name, msg) {
    var log = document.getElementById(name);
    if(log !=null){
        log.textContent += msg + '\n';
    }
    else{
        alert ("Log "+ log + " not found.");
        }
  }
  function alert_errorList(errorList){
	  var errorString="Tinter Resp:";
	  for (var i = 0, len = errorList.length; i < len; i++) {
		  var error = errorList[i];
		  errorString += error[message] + "[" + error[num] + "]\n "
		}
	  }

  var ws_tinter_status="disconnected";
  var ws_coloreye_status="disconnected";

  var ws_tinter;
  var ws_coloreye;

  function CreateTinterWebSocket(){
  // setup websocket with callbacks
  	ws_tinter = new WebSocket('ws://localhost:80/tinter');

 
  	ws_tinter.onopen = function() {
	  ws_tinter_status="connected"
    	log("tinter_log",'CONNECTED');
  };
  ws_tinter.onclose = function() {
	  ws_tinter_status="disconnected"
    log("tinter_log",'DISCONNECTED');
  };
  ws_tinter.onmessage = function(event) {
    log("tinter_log",'MESSAGE: ' + event.data);
    
    var return_message=JSON.parse(event.data);
    
    if(return_message.errorMessage != undefined && return_message.errorMessage !=""){
	    alert("Response from Tinter Driver: " + return_message.errorMessage);
	    }
    if(return_message.errorList !=undefined && return_message.errorList !=null){
		alert_errorList (errorList);
        }
    if(return_message.command == "CalUpload"){
    	putECal(return_message);
        }
  };
  }
  function CreateSpectroWebSocket(){
  var ws_coloreye = new WebSocket('ws://localhost:80/coloreye');
  
  ws_coloreye.onopen = function() {
	  ws_coloreye_status="connected"
	    log("coloreye_log",'CONNECTED');
	  };
	  ws_coloreye.onclose = function() {
		  ws_coloreye_status="disconnected"
	    log("coloreye_log",'DISCONNECT');
	  };
	  /*
	  function SpectroMessage(command){
		this.id=createUUID();
		this.command=command;
		this.rc=0;
		this.errorMessage="";
		this.curve=new SpectralCurve();
}
	  */
	  
	  ws_coloreye.onmessage = function(event) {
	    log("coloreye_log",'MESSAGE: ' + event.data);
	    var return_message=JSON.parse(event.data);
	    
	    if(return_message.errorMessage !=""){
		    alert("Response from Color Eye Driver: " + return_message.errorMessage);
		    }
	  };
  }
  function CloseTinterWebSocket(){
	  if(ws_tinter !=undefined){		
			ws_tinter.close();
			}
	  }
  function CloseSpectroWebsocket(){
		if(ws_coloreye !=undefined){
			ws_coloreye.close();
			}
	  }
  $(document).ready(function() {	
		//this loads on startup!  
			$('#config_tinter_button').click(function(){
				var colorantid = $('#config_colorant').val();
				var model = $('#config_tinter_model').val();
				var serial = $('#config_tinter_serial').val();
			
				config_tinter(colorantid,model,serial);
				
			});	
		$('#restart_btn').click(function(){
			console.log("Restart button clicked");
			CloseTinterWebSocket();
			CloseSpectroWebsocket();
			CreateTinterWebSocket();
			CreateSpectroWebSocket();
		});
    	$('#tinter_send_button').click(function(){
        	
        	var cmd = $('#command').val();
        	var calibration = null;
	        	//code,shots,pos,uom
	        	var shotList=null;
	        	if(cmd == "Dispense"){
	        	var color1 = new Colorant("R3",32,0,128);
	        	var color2 = new Colorant("W1",32,0,128);
	        	var shotList =[color1,color2];
    			}
    			if(cmd=="CalDownload"){
    			
        			calibration = new Calibration( configuration.colorantSystem,configuration.model,configuration.serial);
        		}
    	
	        	var tintermessage = new TinterMessage(cmd,shotList,configuration,calibration);  
	        	if(ws_tinter_status=="disconnected"){
	        		CreateTinterWebSocket();
	            	}
	        	var json = JSON.stringify(tintermessage);
	        	console.log(json);
	        	ws_tinter.send(json);
	        	
        	});
    	
    	$('#ce_send_button').click(function(){
        	var cmd2 = $('#ce_command').val();
        	if(ws_coloreye_status=="disconnected"){
        		CreateSpectroWebSocket();
            	}
        	
        	var spectromessage = new SpectroMessage(cmd2);
        	var json = JSON.stringify(spectromessage);
        	console.log(json);
        	ws_coloreye.send(json);
        	});
    
 		
	});
</script>
</head>

<body bgcolor=ivory>

	<form action="" class="form-inline">
		<input id="restart_btn" type="button"
			value="Restart Websocket Communication">
		<div class="form-group">
			<h3>Config Tinter</h3>
			<label for="config_colorant">Colorant Code</label> <input type="text"
				class="form-control tem-form" id='config_colorant'
				name="config_colorant" /> <label for="config_tinter_model">TinterModel</label>
			<input type="text" class="form-control tem-form"
				id='config_tinter_model' name="config_tinter_model" /> <label
				for="config_tinter_serial">TinterSerial</label> <input type="text"
				class="form-control tem-form" id='config_tinter_serial'
				name="config_tinter_serial" /> <input type="button"
				id="config_tinter_button" value="Send" class="btn btn-primary" />
		</div>
	</form>

	<pre id="tinter_config_log"></pre>


	<form action="" class="form-inline">

		<div class="form-group" id=frm-group>
			<label for="command">Tinter Command</label> <input type="text"
				class="form-control tem-form" id='command' name="command" /> <input
				type="button" id="tinter_send_button" value="Send"
				class="btn btn-primary" />
		</div>
	</form>
	<pre id="tinter_log"></pre>

	<form action="" class="form-inline">

		<div class="form-group">
			<label for="ce_command">ColorEye Command</label> <input type="text"
				class="form-control tem-form" id='ce_command' name="ce_command" />

			<input type="button" id="ce_send_button" value="Send"
				class="btn btn-primary" />
		</div>
	</form>
	<pre id="coloreye_log"></pre>
</body>

